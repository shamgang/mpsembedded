/*
 	FFT.c

	Authors: Shamik Ganguly and Chet Sukh

 	Main file for Music Performance Augmenter visual module.
 	Calculates FFT of input audio, re-bins FFT data
 	pseudo-logarithmically on the frequency axis,
 	plots the data radially, spins the radial plot
 	at different speeds based on a guess of fundamental frequency,
	and sends drawing commands over SPI as master to be
	parsed and drawn to VGA by an FPGA.

	Link with XVGA.c, Spi.c, C5515_eZdsp.c
*/

// TI DSP library
// Functions cfft_SCALE and cbrev are used for FFT and bit reversal
#include <Dsplib.h>
// Spectrum Digital definitions and prototypes for C5515
// Function USBSTK5515_init used for initialization
#include <usbstk5515.h>
// C5515 AIC library made by EECS 452 GSI
// Functions AIC_init, AIC_read2, and AIC_write2 are used for
// initialization of audio input, and reads and writes of the buffer
#include <AIC_func.h>
// Interrupt-related definitions by EECS 452 GSI
#include <usbstk5515_interrupts.h>
// Standard library includes
#include <stdio.h>
#include <math.h>

// Color code for draw message to FPGA
#define BLUE 2
// Size of input buffer
#define BUFSIZE 512
// Number of array elements per input sample
// expected by complex FFT function
#define BUFCHK	2
// Number of output bins that result from rebinning
#define NUM_OUT 23
// Number of radial lines to be drawn
#define NUM_LINES 640
// Radius saturation value
#define RADIUS_MAX 450
// Maximum bin index spin will react to
#define MAX_SPIN_BIN 10
// Number of radials lines per output bin
#define LINES_PER_BIN 60
// Screen center coordinates
#define X_CENTER 320
#define Y_CENTER 240

// From XVGA.c, C5515 XVGA support by Kurt Metzger for EECS 452
// Initialize XVGA
void XVGAinit(Uint16);
// Move to (x,y) with pen up
void GoTo(Uint16 x, Uint16 y);
// Move to (x,y) with pen down
// NOTE: always draws blue
void Draw(Uint16 color, Uint16 x, Uint16 y);

// From Spi.c, C5515 SPI support by Kurt Metzger for EECS 452
// Relies on usbstk5515_spi.h by EECS 452 GSI
// Initialize SPI
void InitSpi(void);

// From C5515_eZdsp.c, system initialization code by Unknown
// Relies on register_system.h by TI
// Initialize system, including clock and peripheral reset
void InitSystem(void);
// Configure ports
void ConfigPort(void);

// Anchor for vector table
void Reset();

// Setup for I2S/AIC interrupt routine by EECS 452 GSI
void I2S_interrupt_setup(void);

// Determine square root for Q number.  Takes a 32-bit Q_FRACBITS and returns
// number in the same representation. Taken from:
// http://jet.ro/files/The_neglected_art_of_Fixed_Point_arithmetic_20060913.pdf
long FFracSqrt(long);

// Input sample counter, resets when buffer fills
Uint32 Counter;

// Rotating input buffers for AIC
DATA bOne	[BUFCHK*BUFSIZE];
DATA bTwo 	[BUFCHK*BUFSIZE];
// FFT output buffer
DATA bOut	[BUFCHK*BUFSIZE];
// Buffer pointers
DATA *pAIC, *pFFT, *pDONE;

// Chebyshev buffers for windowing FFT input
// Should be chosen to match current definition of BUFSIZE
//Int16 cheby[1024] = {67,10,10,11,12,13,14,14,15,16,17,18,19,21,22,23,24,26,27,28,30,31,33,35,36,38,40,42,44,46,48,50,52,54,57,59,62,64,67,70,73,76,79,82,85,88,92,95,99,103,107,111,115,119,123,128,132,137,141,146,151,157,162,167,173,179,185,191,197,203,210,216,223,230,237,245,252,260,268,276,284,292,301,310,319,328,337,347,357,367,377,387,398,409,420,432,443,455,467,480,492,505,518,532,545,559,573,588,603,618,633,649,665,681,697,714,731,749,767,785,803,822,841,861,880,900,921,942,963,985,1006,1029,1051,1074,1098,1122,1146,1170,1195,1221,1247,1273,1299,1327,1354,1382,1410,1439,1468,1498,1528,1558,1589,1621,1653,1685,1718,1751,1785,1819,1854,1889,1925,1961,1998,2035,2073,2111,2150,2189,2229,2269,2310,2352,2394,2436,2479,2523,2567,2611,2657,2702,2749,2796,2843,2891,2940,2989,3039,3089,3140,3192,3244,3297,3350,3404,3459,3514,3570,3626,3683,3741,3799,3858,3917,3977,4038,4100,4162,4224,4288,4351,4416,4481,4547,4614,4681,4749,4817,4886,4956,5026,5097,5169,5242,5315,5388,5463,5538,5613,5690,5767,5844,5923,6002,6081,6162,6243,6324,6407,6490,6573,6658,6743,6828,6914,7001,7089,7177,7266,7356,7446,7537,7628,7720,7813,7907,8001,8095,8191,8287,8383,8481,8578,8677,8776,8876,8976,9077,9179,9281,9384,9487,9591,9696,9801,9907,10013,10120,10228,10336,10444,10554,10663,10774,10884,10996,11108,11220,11333,11447,11561,11675,11790,11906,12022,12139,12256,12373,12491,12610,12728,12848,12968,13088,13208,13329,13451,13573,13695,13818,13941,14064,14188,14312,14437,14562,14687,14813,14939,15065,15191,15318,15445,15573,15700,15828,15956,16085,16214,16342,16472,16601,16730,16860,16990,17120,17250,17381,17511,17642,17773,17904,18035,18166,18297,18428,18560,18691,18823,18954,19086,19217,19349,19480,19611,19743,19874,20006,20137,20268,20399,20530,20661,20792,20922,21053,21183,21313,21443,21573,21703,21832,21961,22090,22219,22347,22475,22603,22731,22858,22985,23111,23238,23363,23489,23614,23739,23863,23987,24111,24234,24356,24479,24600,24721,24842,24962,25082,25201,25320,25438,25555,25672,25789,25904,26020,26134,26248,26361,26474,26586,26697,26807,26917,27026,27135,27242,27349,27455,27561,27665,27769,27872,27974,28076,28176,28276,28375,28473,28570,28666,28761,28856,28949,29042,29133,29224,29314,29402,29490,29577,29663,29748,29831,29914,29996,30077,30156,30235,30312,30389,30464,30539,30612,30684,30755,30825,30893,30961,31028,31093,31157,31220,31282,31342,31402,31460,31517,31573,31628,31681,31733,31784,31834,31882,31930,31976,32020,32064,32106,32147,32187,32225,32262,32298,32333,32366,32398,32428,32458,32486,32512,32538,32562,32585,32606,32626,32645,32662,32678,32693,32707,32719,32729,32739,32747,32754,32759,32763,32766,32767,32767,32766,32763,32759,32754,32747,32739,32729,32719,32707,32693,32678,32662,32645,32626,32606,32585,32562,32538,32512,32486,32458,32428,32398,32366,32333,32298,32262,32225,32187,32147,32106,32064,32020,31976,31930,31882,31834,31784,31733,31681,31628,31573,31517,31460,31402,31342,31282,31220,31157,31093,31028,30961,30893,30825,30755,30684,30612,30539,30464,30389,30312,30235,30156,30077,29996,29914,29831,29748,29663,29577,29490,29402,29314,29224,29133,29042,28949,28856,28761,28666,28570,28473,28375,28276,28176,28076,27974,27872,27769,27665,27561,27455,27349,27242,27135,27026,26917,26807,26697,26586,26474,26361,26248,26134,26020,25904,25789,25672,25555,25438,25320,25201,25082,24962,24842,24721,24600,24479,24356,24234,24111,23987,23863,23739,23614,23489,23363,23238,23111,22985,22858,22731,22603,22475,22347,22219,22090,21961,21832,21703,21573,21443,21313,21183,21053,20922,20792,20661,20530,20399,20268,20137,20006,19874,19743,19611,19480,19349,19217,19086,18954,18823,18691,18560,18428,18297,18166,18035,17904,17773,17642,17511,17381,17250,17120,16990,16860,16730,16601,16472,16342,16214,16085,15956,15828,15700,15573,15445,15318,15191,15065,14939,14813,14687,14562,14437,14312,14188,14064,13941,13818,13695,13573,13451,13329,13208,13088,12968,12848,12728,12610,12491,12373,12256,12139,12022,11906,11790,11675,11561,11447,11333,11220,11108,10996,10884,10774,10663,10554,10444,10336,10228,10120,10013,9907,9801,9696,9591,9487,9384,9281,9179,9077,8976,8876,8776,8677,8578,8481,8383,8287,8191,8095,8001,7907,7813,7720,7628,7537,7446,7356,7266,7177,7089,7001,6914,6828,6743,6658,6573,6490,6407,6324,6243,6162,6081,6002,5923,5844,5767,5690,5613,5538,5463,5388,5315,5242,5169,5097,5026,4956,4886,4817,4749,4681,4614,4547,4481,4416,4351,4288,4224,4162,4100,4038,3977,3917,3858,3799,3741,3683,3626,3570,3514,3459,3404,3350,3297,3244,3192,3140,3089,3039,2989,2940,2891,2843,2796,2749,2702,2657,2611,2567,2523,2479,2436,2394,2352,2310,2269,2229,2189,2150,2111,2073,2035,1998,1961,1925,1889,1854,1819,1785,1751,1718,1685,1653,1621,1589,1558,1528,1498,1468,1439,1410,1382,1354,1327,1299,1273,1247,1221,1195,1170,1146,1122,1098,1074,1051,1029,1006,985,963,942,921,900,880,861,841,822,803,785,767,749,731,714,697,681,665,649,633,618,603,588,573,559,545,532,518,505,492,480,467,455,443,432,420,409,398,387,377,367,357,347,337,328,319,310,301,292,284,276,268,260,252,245,237,230,223,216,210,203,197,191,185,179,173,167,162,157,151,146,141,137,132,128,123,119,115,111,107,103,99,95,92,88,85,82,79,76,73,70,67,64,62,59,57,54,52,50,48,46,44,42,40,38,36,35,33,31,30,28,27,26,24,23,22,21,19,18,17,16,15,14,14,13,12,11,10,10,67};
Int16 cheby[512] = {36,10,12,14,15,17,20,22,24,27,30,33,36,40,44,48,52,57,62,67,73,79,85,92,99,107,115,123,132,142,152,162,173,185,197,210,224,238,253,268,285,302,320,338,358,378,399,422,445,469,494,520,547,575,605,635,667,700,734,769,806,844,883,924,966,1010,1055,1102,1150,1200,1251,1304,1359,1415,1473,1533,1595,1658,1724,1791,1860,1932,2005,2080,2157,2237,2318,2402,2488,2576,2666,2758,2853,2950,3049,3151,3255,3362,3470,3582,3696,3812,3931,4052,4176,4302,4431,4563,4697,4833,4973,5115,5259,5406,5556,5709,5864,6022,6182,6345,6511,6679,6850,7024,7200,7379,7561,7745,7932,8121,8313,8507,8704,8904,9106,9310,9517,9726,9937,10151,10367,10586,10806,11029,11254,11481,11710,11941,12174,12409,12646,12885,13126,13368,13612,13857,14104,14353,14603,14854,15106,15360,15615,15871,16128,16386,16645,16905,17165,17426,17687,17950,18212,18475,18738,19001,19264,19527,19790,20053,20316,20578,20840,21101,21362,21622,21881,22139,22396,22652,22907,23160,23412,23663,23912,24159,24405,24648,24890,25130,25368,25603,25836,26066,26294,26520,26743,26963,27180,27394,27605,27813,28017,28219,28417,28611,28802,28989,29173,29353,29529,29700,29868,30032,30192,30347,30498,30645,30787,30925,31058,31186,31310,31429,31543,31653,31758,31857,31952,32041,32126,32206,32280,32349,32413,32472,32525,32573,32616,32654,32686,32713,32735,32751,32762,32767,32767,32762,32751,32735,32713,32686,32654,32616,32573,32525,32472,32413,32349,32280,32206,32126,32041,31952,31857,31758,31653,31543,31429,31310,31186,31058,30925,30787,30645,30498,30347,30192,30032,29868,29700,29529,29353,29173,28989,28802,28611,28417,28219,28017,27813,27605,27394,27180,26963,26743,26520,26294,26066,25836,25603,25368,25130,24890,24648,24405,24159,23912,23663,23412,23160,22907,22652,22396,22139,21881,21622,21362,21101,20840,20578,20316,20053,19790,19527,19264,19001,18738,18475,18212,17950,17687,17426,17165,16905,16645,16386,16128,15871,15615,15360,15106,14854,14603,14353,14104,13857,13612,13368,13126,12885,12646,12409,12174,11941,11710,11481,11254,11029,10806,10586,10367,10151,9937,9726,9517,9310,9106,8904,8704,8507,8313,8121,7932,7745,7561,7379,7200,7024,6850,6679,6511,6345,6182,6022,5864,5709,5556,5406,5259,5115,4973,4833,4697,4563,4431,4302,4176,4052,3931,3812,3696,3582,3470,3362,3255,3151,3049,2950,2853,2758,2666,2576,2488,2402,2318,2237,2157,2080,2005,1932,1860,1791,1724,1658,1595,1533,1473,1415,1359,1304,1251,1200,1150,1102,1055,1010,966,924,883,844,806,769,734,700,667,635,605,575,547,520,494,469,445,422,399,378,358,338,320,302,285,268,253,238,224,210,197,185,173,162,152,142,132,123,115,107,99,92,85,79,73,67,62,57,52,48,44,40,36,33,30,27,24,22,20,17,15,14,12,10,36};

// FFT bin amplitudes (skip DC)
DATA amps[BUFSIZE-1];

// Sine and cosine tables for polar calculations
// Should match current definition of NUM_LINES
Int16 sinTable[640] = {0, 322, 643, 965, 1286, 1608, 1929, 2250, 2571, 2891, 3212, 3532, 3851, 4171, 4489, 4808, 5126, 5443, 5760, 6077, 6393, 6708, 7022, 7336, 7649, 7962, 8273, 8584, 8894, 9203, 9512, 9819, 10126, 10431, 10735, 11039, 11341, 11642, 11943, 12242, 12539, 12836, 13131, 13425, 13718, 14010, 14300, 14589, 14876, 15162, 15446, 15729, 16011, 16291, 16569, 16846, 17121, 17394, 17666, 17936, 18204, 18471, 18736, 18999, 19260, 19519, 19777, 20032, 20286, 20537, 20787, 21035, 21280, 21524, 21766, 22005, 22242, 22477, 22710, 22941, 23170, 23396, 23620, 23842, 24062, 24279, 24494, 24706, 24916, 25124, 25329, 25532, 25732, 25930, 26126, 26319, 26509, 26697, 26882, 27065, 27245, 27422, 27597, 27769, 27938, 28105, 28269, 28431, 28589, 28745, 28898, 29048, 29196, 29340, 29482, 29621, 29757, 29890, 30021, 30148, 30273, 30394, 30513, 30629, 30742, 30852, 30958, 31062, 31163, 31261, 31356, 31448, 31537, 31623, 31705, 31785, 31862, 31935, 32006, 32073, 32137, 32199, 32257, 32312, 32364, 32412, 32458, 32500, 32540, 32576, 32609, 32639, 32666, 32690, 32710, 32728, 32742, 32753, 32761, 32765, 32767, 32765, 32761, 32753, 32742, 32728, 32710, 32690, 32666, 32639, 32609, 32576, 32540, 32500, 32458, 32412, 32364, 32312, 32257, 32199, 32137, 32073, 32006, 31935, 31862, 31785, 31705, 31623, 31537, 31448, 31356, 31261, 31163, 31062, 30958, 30852, 30742, 30629, 30513, 30394, 30273, 30148, 30021, 29890, 29757, 29621, 29482, 29340, 29196, 29048, 28898, 28745, 28589, 28431, 28269, 28105, 27938, 27769, 27597, 27422, 27245, 27065, 26882, 26697, 26509, 26319, 26126, 25930, 25732, 25532, 25329, 25124, 24916, 24706, 24494, 24279, 24062, 23842, 23620, 23396, 23170, 22941, 22710, 22477, 22242, 22005, 21766, 21524, 21280, 21035, 20787, 20537, 20286, 20032, 19777, 19519, 19260, 18999, 18736, 18471, 18204, 17936, 17666, 17394, 17121, 16846, 16569, 16291, 16011, 15729, 15446, 15162, 14876, 14589, 14300, 14010, 13718, 13425, 13131, 12836, 12539, 12242, 11943, 11642, 11341, 11039, 10735, 10431, 10126, 9819, 9512, 9203, 8894, 8584, 8273, 7962, 7649, 7336, 7022, 6708, 6393, 6077, 5760, 5443, 5126, 4808, 4489, 4171, 3851, 3532, 3212, 2891, 2571, 2250, 1929, 1608, 1286, 965, 643, 322, 0, -322, -643, -965, -1286, -1608, -1929, -2250, -2571, -2891, -3212, -3532, -3851, -4171, -4489, -4808, -5126, -5443, -5760, -6077, -6393, -6708, -7022, -7336, -7649, -7962, -8273, -8584, -8894, -9203, -9512, -9819, -10126, -10431, -10735, -11039, -11341, -11642, -11943, -12242, -12539, -12836, -13131, -13425, -13718, -14010, -14300, -14589, -14876, -15162, -15446, -15729, -16011, -16291, -16569, -16846, -17121, -17394, -17666, -17936, -18204, -18471, -18736, -18999, -19260, -19519, -19777, -20032, -20286, -20537, -20787, -21035, -21280, -21524, -21766, -22005, -22242, -22477, -22710, -22941, -23170, -23396, -23620, -23842, -24062, -24279, -24494, -24706, -24916, -25124, -25329, -25532, -25732, -25930, -26126, -26319, -26509, -26697, -26882, -27065, -27245, -27422, -27597, -27769, -27938, -28105, -28269, -28431, -28589, -28745, -28898, -29048, -29196, -29340, -29482, -29621, -29757, -29890, -30021, -30148, -30273, -30394, -30513, -30629, -30742, -30852, -30958, -31062, -31163, -31261, -31356, -31448, -31537, -31623, -31705, -31785, -31862, -31935, -32006, -32073, -32137, -32199, -32257, -32312, -32364, -32412, -32458, -32500, -32540, -32576, -32609, -32639, -32666, -32690, -32710, -32728, -32742, -32753, -32761, -32765, -32767, -32765, -32761, -32753, -32742, -32728, -32710, -32690, -32666, -32639, -32609, -32576, -32540, -32500, -32458, -32412, -32364, -32312, -32257, -32199, -32137, -32073, -32006, -31935, -31862, -31785, -31705, -31623, -31537, -31448, -31356, -31261, -31163, -31062, -30958, -30852, -30742, -30629, -30513, -30394, -30273, -30148, -30021, -29890, -29757, -29621, -29482, -29340, -29196, -29048, -28898, -28745, -28589, -28431, -28269, -28105, -27938, -27769, -27597, -27422, -27245, -27065, -26882, -26697, -26509, -26319, -26126, -25930, -25732, -25532, -25329, -25124, -24916, -24706, -24494, -24279, -24062, -23842, -23620, -23396, -23170, -22941, -22710, -22477, -22242, -22005, -21766, -21524, -21280, -21035, -20787, -20537, -20286, -20032, -19777, -19519, -19260, -18999, -18736, -18471, -18204, -17936, -17666, -17394, -17121, -16846, -16569, -16291, -16011, -15729, -15446, -15162, -14876, -14589, -14300, -14010, -13718, -13425, -13131, -12836, -12539, -12242, -11943, -11642, -11341, -11039, -10735, -10431, -10126, -9819, -9512, -9203, -8894, -8584, -8273, -7962, -7649, -7336, -7022, -6708, -6393, -6077, -5760, -5443, -5126, -4808, -4489, -4171, -3851, -3532, -3212, -2891, -2571, -2250, -1929, -1608, -1286, -965, -643, -322};
Int16 cosTable[640] = {32767, 32765, 32761, 32753, 32742, 32728, 32710, 32690, 32666, 32639, 32609, 32576, 32540, 32500, 32458, 32412, 32364, 32312, 32257, 32199, 32137, 32073, 32006, 31935, 31862, 31785, 31705, 31623, 31537, 31448, 31356, 31261, 31163, 31062, 30958, 30852, 30742, 30629, 30513, 30394, 30273, 30148, 30021, 29890, 29757, 29621, 29482, 29340, 29196, 29048, 28898, 28745, 28589, 28431, 28269, 28105, 27938, 27769, 27597, 27422, 27245, 27065, 26882, 26697, 26509, 26319, 26126, 25930, 25732, 25532, 25329, 25124, 24916, 24706, 24494, 24279, 24062, 23842, 23620, 23396, 23170, 22941, 22710, 22477, 22242, 22005, 21766, 21524, 21280, 21035, 20787, 20537, 20286, 20032, 19777, 19519, 19260, 18999, 18736, 18471, 18204, 17936, 17666, 17394, 17121, 16846, 16569, 16291, 16011, 15729, 15446, 15162, 14876, 14589, 14300, 14010, 13718, 13425, 13131, 12836, 12539, 12242, 11943, 11642, 11341, 11039, 10735, 10431, 10126, 9819, 9512, 9203, 8894, 8584, 8273, 7962, 7649, 7336, 7022, 6708, 6393, 6077, 5760, 5443, 5126, 4808, 4489, 4171, 3851, 3532, 3212, 2891, 2571, 2250, 1929, 1608, 1286, 965, 643, 322, 0, -322, -643, -965, -1286, -1608, -1929, -2250, -2571, -2891, -3212, -3532, -3851, -4171, -4489, -4808, -5126, -5443, -5760, -6077, -6393, -6708, -7022, -7336, -7649, -7962, -8273, -8584, -8894, -9203, -9512, -9819, -10126, -10431, -10735, -11039, -11341, -11642, -11943, -12242, -12539, -12836, -13131, -13425, -13718, -14010, -14300, -14589, -14876, -15162, -15446, -15729, -16011, -16291, -16569, -16846, -17121, -17394, -17666, -17936, -18204, -18471, -18736, -18999, -19260, -19519, -19777, -20032, -20286, -20537, -20787, -21035, -21280, -21524, -21766, -22005, -22242, -22477, -22710, -22941, -23170, -23396, -23620, -23842, -24062, -24279, -24494, -24706, -24916, -25124, -25329, -25532, -25732, -25930, -26126, -26319, -26509, -26697, -26882, -27065, -27245, -27422, -27597, -27769, -27938, -28105, -28269, -28431, -28589, -28745, -28898, -29048, -29196, -29340, -29482, -29621, -29757, -29890, -30021, -30148, -30273, -30394, -30513, -30629, -30742, -30852, -30958, -31062, -31163, -31261, -31356, -31448, -31537, -31623, -31705, -31785, -31862, -31935, -32006, -32073, -32137, -32199, -32257, -32312, -32364, -32412, -32458, -32500, -32540, -32576, -32609, -32639, -32666, -32690, -32710, -32728, -32742, -32753, -32761, -32765, -32767, -32765, -32761, -32753, -32742, -32728, -32710, -32690, -32666, -32639, -32609, -32576, -32540, -32500, -32458, -32412, -32364, -32312, -32257, -32199, -32137, -32073, -32006, -31935, -31862, -31785, -31705, -31623, -31537, -31448, -31356, -31261, -31163, -31062, -30958, -30852, -30742, -30629, -30513, -30394, -30273, -30148, -30021, -29890, -29757, -29621, -29482, -29340, -29196, -29048, -28898, -28745, -28589, -28431, -28269, -28105, -27938, -27769, -27597, -27422, -27245, -27065, -26882, -26697, -26509, -26319, -26126, -25930, -25732, -25532, -25329, -25124, -24916, -24706, -24494, -24279, -24062, -23842, -23620, -23396, -23170, -22941, -22710, -22477, -22242, -22005, -21766, -21524, -21280, -21035, -20787, -20537, -20286, -20032, -19777, -19519, -19260, -18999, -18736, -18471, -18204, -17936, -17666, -17394, -17121, -16846, -16569, -16291, -16011, -15729, -15446, -15162, -14876, -14589, -14300, -14010, -13718, -13425, -13131, -12836, -12539, -12242, -11943, -11642, -11341, -11039, -10735, -10431, -10126, -9819, -9512, -9203, -8894, -8584, -8273, -7962, -7649, -7336, -7022, -6708, -6393, -6077, -5760, -5443, -5126, -4808, -4489, -4171, -3851, -3532, -3212, -2891, -2571, -2250, -1929, -1608, -1286, -965, -643, -322, 0, 322, 643, 965, 1286, 1608, 1929, 2250, 2571, 2891, 3212, 3532, 3851, 4171, 4489, 4808, 5126, 5443, 5760, 6077, 6393, 6708, 7022, 7336, 7649, 7962, 8273, 8584, 8894, 9203, 9512, 9819, 10126, 10431, 10735, 11039, 11341, 11642, 11943, 12242, 12539, 12836, 13131, 13425, 13718, 14010, 14300, 14589, 14876, 15162, 15446, 15729, 16011, 16291, 16569, 16846, 17121, 17394, 17666, 17936, 18204, 18471, 18736, 18999, 19260, 19519, 19777, 20032, 20286, 20537, 20787, 21035, 21280, 21524, 21766, 22005, 22242, 22477, 22710, 22941, 23170, 23396, 23620, 23842, 24062, 24279, 24494, 24706, 24916, 25124, 25329, 25532, 25732, 25930, 26126, 26319, 26509, 26697, 26882, 27065, 27245, 27422, 27597, 27769, 27938, 28105, 28269, 28431, 28589, 28745, 28898, 29048, 29196, 29340, 29482, 29621, 29757, 29890, 30021, 30148, 30273, 30394, 30513, 30629, 30742, 30852, 30958, 31062, 31163, 31261, 31356, 31448, 31537, 31623, 31705, 31785, 31862, 31935, 32006, 32073, 32137, 32199, 32257, 32312, 32364, 32412, 32458, 32500, 32540, 32576, 32609, 32639, 32666, 32690, 32710, 32728, 32742, 32753, 32761, 32765};

// Rebinned FFT output
LDATA outbins[NUM_OUT];
// Radii for each output bin
Int16 R[NUM_OUT] = {0};
// Radii from previous iteration
Int16 prev_R[NUM_OUT] = {0};

// I2S interrupt for AIC audio sample handling
interrupt void I2S_ISR()
{
	Int16 right, left;
	// Pass sample through to output
	AIC_read2(&right, &left);
	AIC_write2(right, left);
	// Store samples in buffer unless full, then skip
	if(Counter < (BUFSIZE*BUFCHK))
	{
		pAIC[Counter] = right;  //Only use evens for FFT function
		pAIC[Counter+1] = 0;	//No imaginary part
		Counter += 2;
	}
	// Clear interrupt flag
	IFR0 &= (1 << I2S_BIT_POS);
}

void main(void)
{
	// Temporary variables
	Int32 tmp, tmp2;
	DATA *temp1;
	// Assign buffer pointers
	pAIC = &bOne[0];
	pFFT = &bTwo[0];
	pDONE = &bOut[0];
	// Clear sample counter
	Counter = 0;
	// Counter for spinning display
	Int16 spin = 0;
	// Sine-table index with spin
	Int16 spindex = 0;
	// XVGA start switch
	Uint16 start_switch;
	start_switch = 1;
	// Initializations
	InitSystem();
	ConfigPort();
	InitSpi();
	USBSTK5515_init();
	AIC_init();
	I2S_interrupt_setup();
	// Enable interrupts
	_enable_interrupts();

	while(1)
	{
		// Collect samples through interrupt until buffer full
		if(Counter >= (BUFSIZE*BUFCHK))
		{
			// Rotate buffers
			temp1= pFFT;
			pFFT = pAIC;
			pAIC = temp1;

			// Reset sample counter
			Counter = 0;

			// Apply Chebyshev windowing
			Int16 j;
			for(j = 0; j < BUFSIZE; j++) {
				pFFT[BUFCHK*j] = ((Int32)cheby[j] * (Int32)pFFT[BUFCHK*j]) >> 15;
			}

			// Perform complex FFT with scaling.
			cfft_SCALE(pFFT, BUFSIZE);
			// Bit reversal
			cbrev(pFFT, pDONE, BUFSIZE);

			// Initialize XVGA transmission
			XVGAinit(start_switch);   // switch display page
			start_switch = 0;

			// Calculate magnitudes of each FFT bin
			Int16 i;
			// Index of maximum bin
			Int16 bindex = 0;
			for(i = 1; i < BUFSIZE/2; i++) {
				// Calculate magnitude
				tmp = ((Int32)pDONE[i*BUFCHK]*pDONE[i*BUFCHK]) + ((Int32)pDONE[i*BUFCHK+1] * pDONE[i*BUFCHK+1]);
				tmp2 = FFracSqrt(tmp);
				// Hardcoded scaling
				tmp2 = tmp2 >> 14;
				// Saturate
				amps[i-1] = tmp2>32767?32767:tmp2<-32768?-32768:tmp2;
				// Hardcoded linear scaling compensation
				// for damping low frequencies
				if(i < 15){
					amps[i-1] = ((Int32)amps[i-1] * (Int32) 1000 * (Int32) i + (Int32)14000) >> 11;
				}
				// Calculate max
				if(amps[i-1] > amps[bindex]){
					bindex = i-1;
				}
			}

			// Pseudo-logarithmic rebinning:
			// Put freq. bin 1 in output bin 1. Put freq. bin 2,3 in output bin 2.
			// Continue increasing number of bins per output bin until BUFSIZE-1
			// bins have been used.
			Int16 bin = 1;
			Int16 avg_over = 1;
			Int16 out_bin = 0;
			Int16 k;
			Int32 Acc;
			while(bin<BUFSIZE/2){
				Acc = 0;
				for(k = 0;k<avg_over;k++){
					if(bin >= BUFSIZE/2) continue;
					Acc += amps[bin];
					bin++;
				}
				outbins[out_bin] = Acc;
				avg_over++;
				out_bin++;
			}

			// Calculate radius value using rebinned FFT data
			int m = 0;
			for(m = 0; m < NUM_OUT; m++){
				// Remember radii for one iteration
				prev_R[m] = R[m];
				// Hardcoded scaling
				R[m] = outbins[m] >> 1;
				// Saturate
				R[m] = (R[m] > RADIUS_MAX) ? RADIUS_MAX : R[m];
			}

			// Change spin speed based on maximal FFT bin
			// Ignore maximal bin if too high to reduce noise effects
			if(amps[bindex] < MAX_SPIN_BIN){
				bindex = 0;
			}
			// Increment spin counter based on maximal bin
			spin = (spin + bindex) % NUM_LINES;

			// Draw radial spectrum
			// Rectangular coordinates for endpoint of radial draw
			Int16 xb, yb;
			// Radius average
			Int32 avg = 0;
			// Radial line index
			k = 0;
			for (i = 0; i < NUM_OUT; i++){
				for(j = 0; j < LINES_PER_BIN; j++){
					// Go to screen center
					GoTo(X_CENTER, Y_CENTER);
					// Average current and previous radii for smoothing
					avg = ((Int32)R[i] + (Int32)prev_R[i]) >> 1;
					// Sine table index, line index plus spin
					spindex = (k + spin) % NUM_LINES;
					// xb = x0 - r*sin(theta)
					xb = X_CENTER - (Int16)((avg*(Int32)sinTable[spindex]) >> 16);
					// yb = x0 - r*cos(theta)
					yb = Y_CENTER - (Int16)((avg*(Int32)cosTable[spindex]) >> 16);
					// Draw to endpoint
					Draw(BLUE, xb, yb);
					k++;
				}
			}
		}
	}
}

void I2S_interrupt_setup(void)
{
	// Set up vector table
	Uint32 reset_loc = (Uint32)Reset;
	IVPD = reset_loc >> 8; // pointer table points to Reset
	IVPH = reset_loc >> 8;

	// Point to I2S_ISR
	*((Uint32*)((reset_loc + I2S_ISR_OFFSET)>>1)) = (Uint32)I2S_ISR;

	// Set the External bus select SP0Mode to I2S
	SYS_EXBUSSEL |= (0x1 << 8);
	// Set up the Global interrupt register to flag on I2S receive flag
	IER0 |= (1 << I2S_BIT_POS);
	IFR0 &= (1 << I2S_BIT_POS);
}

long FFracSqrt(long x)
{
	/* The definitions below yield 2 integer bits, 30 fractional bits */
	#define FRACBITS 30    /* Must be even! */
	#define ITERS    (15 + (FRACBITS >> 1))

    unsigned long root, remHi, remLo, testDiv, count;
    root = 0;         /* Clear root */
    remHi = 0;        /* Clear high part of partial remainder */
    remLo = x;        /* Get argument into low part of partial remainder */
    count = ITERS;    /* Load loop counter */
    do {
        remHi = (remHi << 2) | (remLo >> 30); remLo <<= 2;  /* get 2 bits of arg */
        root <<= 1;   /* Get ready for the next bit in the root */
        testDiv = (root << 1) + 1;    /* Test radical */
        if (remHi >= testDiv) {
            remHi -= testDiv;
            root += 1;
        }
    } while (count-- != 0);
return(root);
}
